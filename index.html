<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>ESP Provisioning</title>

    <script
      type="module"
      src="https://unpkg.com/esp-web-tools@9/dist/web/install-button.js"></script>

    <style>
      body {
        margin: 0;
        height: 100vh;
        display: flex;
        font-family: monospace;
      }
      #left {
        flex: 1;
        padding: 24px;
      }
      #right {
        width: 40%;
        background: #0b0b0b;
        color: #00ff66;
        padding: 12px;
        overflow-y: auto;
        border-left: 2px solid #222;
      }
      input,
      textarea,
      button {
        width: 100%;
        padding: 8px;
        margin: 6px 0;
        font-family: monospace;
      }
    </style>
  </head>

  <body>
    <div id="left">
      <h3>Flash firmware</h3>
      <esp-web-install-button manifest="manifest.json">
        <button>Flash</button>
      </esp-web-install-button>

      <hr />

      <input id="wifiSSID" placeholder="WiFi SSID" />
      <input id="wifiPassword" placeholder="WiFi Password" />
      <input id="macAddress" placeholder="MAC AA:BB:CC:DD:EE:FF" />
      <input id="botToken" placeholder="Bot Token" />
      <textarea
        id="userIds"
        rows="3"
        placeholder="User IDs (mỗi dòng 1 ID)"></textarea>
      <input id="pcIP" value="192.168.1.150" />
      <input id="psIP" value="192.168.1.100" />

      <button id="connect">Connect ESP</button>
      <button id="send" disabled>Send Config</button>
    </div>

    <div id="right" id="logPanel">
      <b>SERIAL LOG</b><br /><br />
      <div id="log"></div>
    </div>

    <script>
      let port, writer;

      const logBox = document.getElementById('log');
      function log(msg) {
        logBox.innerHTML += msg + '<br>';
        document.getElementById('right').scrollTop =
          document.getElementById('right').scrollHeight;
      }

      connect.onclick = async () => {
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 9600 });
        log(baudRate);
        const decoder = new TextDecoderStream();
        port.readable.pipeTo(decoder.writable);
        const reader = decoder.readable.getReader();

        writer = port.writable.getWriter();
        send.disabled = false;

        log('✔ CONNECTED');

        while (true) {
          const { value } = await reader.read();
          if (value) log(value.replace(/\n/g, '<br>'));
        }
      };

      send.onclick = async () => {
        const config = {
          wifiSSID: wifiSSID.value,
          wifiPassword: wifiPassword.value,
          macAddress: macAddress.value,
          botToken: botToken.value,
          botOwnerIds: userIds.value.split('\n'),
          PCTargetIP: pcIP.value,
          PSTargetIP: psIP.value,
        };

        await writer.write(
          new TextEncoder().encode(JSON.stringify(config) + '\n'),
        );

        log('→ CONFIG SENT');
      };
    </script>
  </body>
</html>
