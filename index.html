<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>ESP Provisioning</title>

    <script
      type="module"
      src="https://unpkg.com/esp-web-tools@9/dist/web/install-button.js"></script>

    <style>
      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        height: 100vh;
        font-family: monospace;
        display: flex;
      }

      /* ===== LEFT PANEL ===== */
      #left {
        flex: 1;
        padding: 24px;
        overflow-y: auto;
      }

      h2,
      h3 {
        margin-top: 0;
      }

      input,
      textarea,
      button {
        width: 100%;
        padding: 8px;
        margin: 6px 0;
        font-family: monospace;
      }

      textarea {
        resize: vertical;
      }

      /* ===== RIGHT LOG PANEL ===== */
      #right {
        width: 40%;
        background: #0b0b0b;
        color: #00ff66;
        padding: 12px;
        border-left: 2px solid #222;
        overflow-y: auto;
        white-space: pre-wrap;
      }

      #right h3 {
        margin-top: 0;
        color: #7dffb3;
      }

      .ok {
        color: #00ff66;
      }

      .err {
        color: #ff5555;
      }
    </style>
  </head>

  <body>
    <!-- LEFT -->
    <div id="left">
      <h2>ESP Flash + Config</h2>

      <h3>1Ô∏è‚É£ Flash firmware</h3>
      <esp-web-install-button manifest="manifest.json">
        <button>Flash Firmware</button>
      </esp-web-install-button>

      <hr />

      <h3>2Ô∏è‚É£ Config</h3>

      <input id="wifiSSID" placeholder="WiFi SSID" />
      <input id="wifiPassword" placeholder="WiFi Password" />

      <input id="macAddress" placeholder="Target MAC (AA:BB:CC:DD:EE:FF)" />

      <input id="botToken" placeholder="Bot Token" />

      <textarea
        id="userIds"
        rows="3"
        placeholder="User IDs (m·ªói d√≤ng 1 ID)"></textarea>

      <input id="pcIP" value="192.168.1.150" />
      <input id="psIP" value="192.168.1.100" />

      <button id="connect">üîå Connect ESP</button>
      <button id="send" disabled>üì§ Send Config</button>
    </div>

    <!-- RIGHT -->
    <div id="right">
      <h3>üìü Serial Log</h3>
      <div id="log"></div>
    </div>

    <script>
      let port, writer;

      const logBox = document.getElementById('log');

      function log(msg, type = 'ok') {
        const line = document.createElement('div');
        line.textContent = msg;
        line.className = type;
        logBox.appendChild(line);
        document.getElementById('right').scrollTop =
          document.getElementById('right').scrollHeight;
      }

      connect.onclick = async () => {
        try {
          port = await navigator.serial.requestPort();
          await port.open({ baudRate: 115200 });

          const decoder = new TextDecoderStream();
          port.readable.pipeTo(decoder.writable);
          const reader = decoder.readable.getReader();

          writer = port.writable.getWriter();
          send.disabled = false;

          log('‚úî ESP connected');

          // ƒë·ªçc log t·ª´ ESP
          while (true) {
            const { value } = await reader.read();
            if (value) log('ESP ‚Üí ' + value.trim());
          }
        } catch (e) {
          log('ERROR: ' + e.message, 'err');
        }
      };

      send.onclick = async () => {
        const owners = userIds.value
          .split('\n')
          .map((v) => v.trim())
          .filter((v) => v.length);

        const config = {
          wifiSSID: wifiSSID.value,
          wifiPassword: wifiPassword.value,
          macAddress: macAddress.value,
          botToken: botToken.value,
          botOwnerIds: owners,
          PCTargetIP: pcIP.value,
          PSTargetIP: psIP.value,
        };

        await writer.write(
          new TextEncoder().encode(JSON.stringify(config) + '\n'),
        );

        log('‚Üí CONFIG SENT');
      };
    </script>
  </body>
</html>
