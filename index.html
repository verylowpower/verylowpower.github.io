<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>ESP Config Tool</title>
    <style>
      body {
        margin: 0;
        font-family: monospace;
        display: flex;
        height: 100vh;
      }

      #form {
        flex: 1;
        padding: 20px;
      }

      #log {
        width: 40%;
        background: #111;
        color: #0f0;
        padding: 10px;
        overflow-y: auto;
      }

      input,
      textarea,
      button {
        width: 100%;
        margin-bottom: 10px;
        padding: 8px;
      }
    </style>
  </head>

  <body>
    <div id="form">
      <h2>ESP Configuration</h2>

      <input id="ssid" placeholder="WiFi SSID" />
      <input id="pass" placeholder="WiFi Password" />
      <input id="mac" placeholder="Target MAC (AA:BB:CC:DD:EE:FF)" />
      <input id="token" placeholder="Bot Token" />

      <textarea
        id="owners"
        rows="3"
        placeholder="Bot Owner IDs (mỗi dòng 1 ID)"></textarea>

      <input id="pcip" value="192.168.1.150" />
      <input id="psip" value="192.168.1.100" />

      <button onclick="connect()">Connect</button>
      <button onclick="send()">Send Config</button>
    </div>

    <div id="log"></div>

    <script>
      let port, writer;

      function log(msg) {
        const box = document.getElementById('log');
        box.innerHTML += msg + '<br>';
        box.scrollTop = box.scrollHeight;
      }

      async function connect() {
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 115200 });

        const decoder = new TextDecoderStream();
        port.readable.pipeTo(decoder.writable);
        const reader = decoder.readable.getReader();

        writer = port.writable.getWriter();
        log('✔ Connected');

        while (true) {
          const { value } = await reader.read();
          if (value) log('ESP → ' + value);
        }
      }

      async function send() {
        const owners = document
          .getElementById('owners')
          .value.split('\n')
          .map((v) => v.trim())
          .filter((v) => v.length);

        const cfg = {
          wifiSSID: document.getElementById('ssid').value,
          wifiPassword: document.getElementById('pass').value,
          macAddress: document.getElementById('mac').value,
          botToken: document.getElementById('token').value,
          botOwnerIds: owners,
          PCTargetIP: document.getElementById('pcip').value,
          PSTargetIP: document.getElementById('psip').value,
        };

        await writer.write(JSON.stringify(cfg) + '\n');
        log('→ CONFIG SENT');
      }
    </script>
  </body>
</html>
